name: Build AutoTranslate iOS Dylib

on:
  push:
    paths:
      - '自动翻译插件/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Theos
      run: |
        brew install ldid xz
        git clone --recursive https://github.com/theos/theos.git $HOME/theos
        echo "THEOS=$HOME/theos" >> $GITHUB_ENV
        
    - name: Download iOS SDK
      run: |
        cd $HOME/theos/sdks
        # 从theos官方sdks仓库克隆
        git clone --depth 1 https://github.com/theos/sdks.git temp_sdks
        mv temp_sdks/*.sdk . 2>/dev/null || true
        rm -rf temp_sdks
        # 如果没有sdk，尝试其他方式
        if [ ! -d "iPhoneOS"*".sdk" ]; then
          # 使用Xcode自带的SDK
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path 2>/dev/null || echo "")
          if [ -n "$SDK_PATH" ] && [ -d "$SDK_PATH" ]; then
            ln -s "$SDK_PATH" iPhoneOS14.5.sdk
          fi
        fi
        ls -la
        
    - name: Build AutoTranslate Dylib
      run: |
        cd 自动翻译插件
        export THEOS=$HOME/theos
        export PATH=$THEOS/bin:$PATH
        make package FINALPACKAGE=1
        
    - name: Extract Dylib
      run: |
        cd 自动翻译插件
        mkdir -p output
        # 找到生成的deb包
        DEB_FILE=$(find packages -name "*.deb" | head -1)
        if [ -n "$DEB_FILE" ]; then
          dpkg-deb -x "$DEB_FILE" extracted
          find extracted -name "*.dylib" -exec cp {} output/ \;
        fi
        # 如果有直接生成的dylib
        find .theos -name "*.dylib" -exec cp {} output/ \; 2>/dev/null || true
        ls -la output/
        
    - name: Upload Dylib
      uses: actions/upload-artifact@v4
      with:
        name: AutoTranslate-Dylib
        path: 自动翻译插件/output/*.dylib
        if-no-files-found: warn
        
    - name: Upload Full Package
      uses: actions/upload-artifact@v4
      with:
        name: AutoTranslate-Package
        path: 自动翻译插件/packages/*.deb
        if-no-files-found: warn
